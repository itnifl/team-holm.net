<p class="blogheader" style="margin-bottom:2px;"><A NAME="VMWareUSBInst"><u>ESXi Scripted USB Install</u></A></p>
<p class="smaller">-31st of December 2015</p>
<h2>Getting started</h2>
<table width="100%">
	<tr>
		<td style="background-color:#fafafa;">
			This article will contain a technical description of creating, and auto-creating scripted ESXi installs from USB. The USB drive we will be using for the install will be partitioned into three partitions labeled <b>INSTALL</b>, <b>CONFIG</b> and <b>SETUP</b>. 
			<br/><br/>
			The first partition (<b>INSTALL</b>) will be a FAT32 partition and contain the ESXi installer files, the scripts to automate the installer, syslinux bootloader and a tftp client to download configuration we need to automatically set up our ESXi host.
			The second parttion (<b>CONFIG</b>) will be a FAT16 partition that contains patches that we will use to patch our installation automatically, log files from the installation will be stored here, and a configuration file downloaded from our TFTP server will be placed here.
			The third and last partition (<b>SETUP</b>) will be a NTFS partition that will contain any script files or setup installers that we might need for later usage when working with our ESXi server that we have auto-installed.
			<br/><br/>
			The setup procdure will be described as performed in Linux, by using BASH scripts. This can also be done in Windows, but will require other technical expertise to acquire this, and is not described here. The whole automation is performed for VMware ESXi 5.5.
		</td>
	</tr>
</table>
<h2>1. Downloading the TFTP client source code and compiling it for use </h2>
	<table width="100%">
		<tr>
			<td style="background-color:white;">
				To make our TFTP client work in an ESXi environment, we need to compile it statically in an OS environment that is as similar to an ESXi as we can get it. 
				Even though ESXi is not Linux, the closest we will get is with Centos 6.x. In this example we will use Centos 6.7 for i386 architecture for compiling the code. Compiling the code statically makes linked libraries included
				in the compiled result, which makes us able to run the compiled code on the ESXi even if a needed code library might be missing there. This is true to a certain degree. Some TFTP clients depend heavily on 
				code frameworks and other libraries, that don't get included in the compiled code even when we compile the code statically. This is why we want to find a light-weight TFTP client that depends mostly on its own code
				and uses only standard C-libraries as much as possible. In the search of such an client, I have picked a <a href="https://github.com/lanrat/tftp" class="articleLink" target="_blank">TFTP client</a> writte by Ian Foster. 
				To improve the client as I wanted, I rewrote it as shown <a href="https://github.com/itnifl/TFTP-client" class="articleLink" target="_blank">here.</a> The improvements made to the client are described in the readme and the comments in the code.
				Clone the code from Ian Foster, and replace tftpclient.c with my altered code <a href="https://github.com/itnifl/TFTP-client" class="articleLink" target="_blank">found here.</a><br/>
				<br/>
				After installing and setting up Cento 6.x and downloading the TFTP client code on to it, you will need to install the builder tools needed to compile the TFTP client:<br/>
				<pre class="brush: bash;">
					yum install build-essential gcc make
				</pre>
				Then head on over to the folder where you have placed the TFTP source code and compile it:<br/>
				<pre class="brush: bash;">
					make CFLAGS="-static" EXEEXT="-static"
				</pre>
				Now you will have the compiled tftpclient (a file without a filename extension) in the same folder as where you  compiled the code. We now need to create a compressed tar ball and convert that into a t00 file that we will include in the ESXi installer to be installed with the rest of the system. Please see a example script below. read through it, it contains more actions then you possibly might need. I keep these here  for inspiration of possible technical solutions.<br/>
				<pre class="brush: bash;">
					#! /bin/bash

					mkdir -p /tmp/ovf/files
					mkdir -p /tmp/ovf/tools
					mkdir -p /tmp/ovf/bin
					mkdir -p /tmp/ovf/bin/tftp
					
					rm -rf /tmp/tftp
					mkdir -p /tmp/tftp
					cd /tmp/tftp
					#We have our compiled TFTP code in tftp-compiled.tar.gz, copy it here:
					cp /usr/arbitrarylocation/tftp-compiled.tar.gz .
					tar xzvf tftp-compiled.tar.gz
					rsync -au /tmp/tftp/* /tmp/ovf/bin/tftp/
					
					#We are including ovf-tool with our ESXi installer:
					rsync -au /usr/lib/vmware-ovftool/* /tmp/ovf/tools/
					sed -i 's/bash/sh/' /tmp/ovf/tools/ovftool
					
					#We are including a private and public key for use with automatic SSH authentication:
					cp /usr/arbitrarylocation/deployment_rsa /tmp/ovf/files/deployment_rsa
					cp /usr/arbitrarylocation/esxi/deployment_rsa.pub /tmp/ovf/files/deployment_rsa.pub

					#Now create the t00 file and place it on the usb disk where it will be used:
					cd /tmp
					tar cf ovf.tar ovf
					gzip -9 ovf.tar
					mv ovf.tar.gz /mnt/usb/ovf-00.t00
					chmod 777 /mnt/usb/ovf-00.t00
				</pre>
				Here /mnt/usb/ovf-00.t00 is the file we are going to include in our VMware ESXi installer. We will copy that file to the <b>INSTALL</b> partition that we will make, and refer to it via boot.cfg. This same file lso refers to ks.cfg, which will be our kickstart installer script to setup the ESXi.

			</td>
		</tr>
	</table>
<h2>2. Partitioning the disk and installing Syslinux on the INSTALL(boot) partition</h2>
	<table width="100%">
		<tr>
			<td style="background-color:white;">
				The following BASH script will partition your USB disk for you. Be aware that will will wipe everythig on it. To run it, paste the code in a textfile and make it executeable:<br/>
				<pre class="brush: bash;">chmod 755 nameOfScript.sh</pre>
				The script to do th partitioning is as follows:
				<pre class="brush: bash;">
					#!/bin/bash
					DISKPARTITION=$1

					if [ -z "$DISKPARTITION" ]; then
						echo -e "\e[31mError: Invalid arguments $0 \e[0m"
						echo -e "Example usage: $0 sdc"
						echo -e "First argument is disk to partition."
						exit 1
					fi
					if mount | grep -E '(^| )/mnt/usb( |$)' > /dev/null; then
						umount /mnt/usb
					fi

					echo -e "\e[35m **Wiping out all partitions on /dev/$DISKPARTITION .. \e[0m"
					dd if=/dev/zero of=/dev/$DISKPARTITION  bs=512  count=1
					echo -e "\e[35m **Creating three new partitions on $DISKPARTITION \e[0m"
					echo -e "d\nn\np\n1\n2048\n+1GB\nn\np\n2\n\n+1GB\nn\np\n3\n\n\nt\n1\nb\nt\n2\n6\nt\n3\n7\nw\n" | fdisk /dev/$DISKPARTITION > /dev/null

					echo -e "\e[35m **Formatting partitions .. \e[0m"
					/sbin/mkfs.vfat -F 32 -n INSTALL /dev/${DISKPARTITION}1
					/sbin/mkfs.vfat -F 16 -n CONFIG /dev/${DISKPARTITION}2
					mkfs.ntfs -L SETUP -f /dev/${DISKPARTITION}3
				</pre>
				Next we need to install our bootloader, Syslinux to our USB disk. This will make it bootable. Please note that the version of VMware ESXi you are using might only support certain versions of Syslinux. In this example, Syslinux 4.05 was used for usage with ESXi 5.5. 
				<pre class="brush: bash;">
					#!/bin/bash
					DISKPARTITION=$1
					if [ -z "$DISKPARTITION" ]; then
						echo -e "\e[31mError: Did not receive argument for disk partition in $0 \e[0m"
						echo -e "Example usage: $0 sdc"
						exit 1
					fi
					echo -e "\e[35m **Removing any possible GPT data on /dev/$DISKPARTITION.. \e[0m"
					sgdisk --zap /dev/$DISKPARTITION
					echo -e "\e[35m **Installing syslinux to /dev/${DISKPARTITION}1.. \e[0m"
					syslinux -i /dev/${DISKPARTITION}1
					echo -e "\e[35m **Copying in mbr to /dev/$DISKPARTITION.. \e[0m"
					dd conv=notrunc bs=440 if=/usr/lib/syslinux/mbr.bin of=/dev/$DISKPARTITION
					echo -e "\e[35m **Setting bootflag on parted /dev/$DISKPARTITION.. \e[0m"
					parted /dev/$DISKPARTITION set 1 boot on
				</pre>
			</td>
		</tr>
	</table>
<h2>3. Set up scripts and configuration files for an automated bootable installation</h2>
	<table width="100%">
		<tr>
			<td style="background-color:white;">
				The following script will copy in all files from the VMware ESXi ISO, provided that it is available under /dev/cdrom (mounted iso in a virtual machine for instance). When this is done, we create syslinux.cfg to tell syslinux how to and what to boot.
				<pre class="brush: bash;">
					#!/bin/bash
					echo -e "\e[35m **Starting section where we copy in from ESXi ISO to ESXI USB.. \e[0m"
					DISKPARTITION=$1
					if [ -z "$DISKPARTITION" ]; then
						echo -e "\e[31mError: Did not receive argument for disk partition in $0 \e[0m"
						echo -e "Example usage: $0 sdc"
						exit 1
					fi

					if [ ! -z "$DISKPARTITION" ]; then
						if [ ! -d "/mnt/usb" ]; then 
							mkdir -p /mnt/usb
						fi
						if mount | grep -E '(^| )/mnt/usb( |$)' > /dev/null; then
							umount /mnt/usb
						fi
						mount -t vfat /dev/${DISKPARTITION}1 /mnt/usb
						if mount | grep -E '(^| )/mnt/usb( |$)' > /dev/null; then
							echo -e "\e[35m **Usb successfully mounted, starting copy..\e[0m" 
							if mount | grep /mnt/cdrom > /dev/null; then
								umount /mnt/cdrom
							fi
							mount /dev/cdrom /mnt/cdrom
							rsync -au /mnt/cdrom/ /mnt/usb/
							echo -e "\e[35m **Copy done, setting up syslinux.cfg..\e[0m" 
							cp /mnt/cdrom/isolinux.cfg /mnt/usb/syslinux.cfg
							sed -i 's|menu.c32|mboot.c32|' /mnt/usb/syslinux.cfg
						fi
						if mount | grep -E '(^| )/mnt/usb( |$)' > /dev/null; then
							umount /mnt/usb
						fi
						if mount | grep /mnt/cdrom > /dev/null; then
							umount /mnt/cdrom
						fi
					fi
				</pre>
				Here below is a script that places our custom BOOT.CFG and KS.CFG at the usb installation media. BOOT.CFG is pointed to by syslinux.cfg and contains information about the installer we are going to use, what files it will load and with what settings. It is in BOOT.CFG we will plae the nme of the t00 package we created with our TFTP client after copying the file to the USB disk. BOOT.CFG also points to KS.CFG which is the script that performs the ESXi installation, uses the TFTP client we compiled and sets up the ESXi server.
				<pre class="brush: bash;">
					#!/bin/bash
					echo -e "\e[35m **Copying ESXi kickstart files.. \e[0m"
					DISKPARTITION=$1

					if [ -z "$DISKPARTITION" ]; then
						echo -e "\e[31mError: invalid arguments in $0 \e[0m"
						echo -e "Example usage: $0 sdc"
						exit 1
					fi
					if mount | grep -E '(^| )/mnt/usb( |$)' > /dev/null; then
						umount /mnt/usb
					fi
					mount -t vfat /dev/${DISKPARTITION}1 /mnt/usb

					echo -e "\e[35m       HP setup files are being copied..\e[0m"
					cp /usr/arbitraryLocation/BOOT.CFG /mnt/usb/BOOT.CFG
					cp /usr/arbitraryLocation/KS.CFG /mnt/usb/KS.CFG					
				</pre>
				This section will be updated later with BOOT.CFG an KS.CFG.	<br/>
				Check by.
			</td>
		</tr>
	</table>
<h2>4. Copy in any tools needed to the SETUP partition</h2>
	<table width="100%">
		<tr>
			<td style="background-color:white;">
				This section will be written later.	<br/>
				Check by.
			</td>
		</tr>
	</table>
	<br/>
	All these sections will sum up a automativ USB based deployment. Please comment your experiences below.
	<br/>
	<br/>
	<i><b><u>Source</u>: VMware and <a href="https://github.com/lanrat/tftp" class="articleLink" target="_blank">github</a>.
	</b></i>
	</p>
</p>